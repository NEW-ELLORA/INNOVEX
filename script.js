
        // --- I18N & TRANSLATIONS ---
        const translations = {
            en: {
                nav_home: "Home", nav_dashboard: "Dashboard", nav_features: "Features", nav_marketplace: "Marketplace", btn_login: "Login / Get Started",
                hero_title_1: "The Future of Farming", hero_title_2: "is Growing.", hero_subtitle: "KrishiSetu uses AI-driven analytics and a decentralized marketplace to bring transparency to your fields.", btn_view_dash: "View Dashboard", btn_portal_login: "Portal Login",
                dash_title: "Your Smart Farm Dashboard", dash_subtitle: "Real-time data from your fields. AI-driven insights.", chart_title: "Crop Yield Forecast", sensors_title: "Live Sensors", sensor_soil: "Soil Moisture", sensor_sun: "Sunlight (UV)", sensor_temp: "Temp",
                feat_ai_title: "AI Analytics", feat_ai_desc: "Predict yields and detect diseases with 99.8% accuracy.", feat_auto_title: "Smart Auto", feat_auto_desc: "Integrate with IoT drones and smart irrigation systems.", feat_block_title: "Blockchain", feat_block_desc: "Traceable supply chain from seed to supermarket.",
                about_title_1: "Connecting", about_title_2: "Farmers", about_desc: "Empowering every farmer with the technology of tomorrow.",
                market_title: "A Fairer Market", market_desc: "Browse, buy, and sell on our verified marketplace.", prod_saffron: "Saffron", prod_drones: "Drones", prod_greens: "Greens", prod_credits: "Credits",
                footer_rights: "All rights reserved.",
                login_title: "Select Your Portal", admin_login: "Admin Login", admin_desc: "Create DAN & Register Farmers", farmer_login: "Farmer Login", farmer_desc: "Access Farm Details with DAN", back_home: "Back to Home",
                admin_sec: "Admin Security", password: "Password", ph_pass: "Enter: admin123", btn_unlock: "Unlock Portal", btn_cancel: "Cancel",
                farmer_access: "Farmer Access", enter_dan: "Enter your Digital Application Number", btn_view_farm: "View Farm",
                admin_console: "Admin Console", admin_console_desc: "Manage Farmers, Supplies, Offers & Support", btn_logout: "Logout", add_farmer: "Add New Farmer", lbl_fullname: "Full Name", lbl_plot: "Plot/Survey No.", lbl_addr: "Address", lbl_area: "Total Area (Acres)", lbl_mac: "ESP32 MAC Address", btn_gen_dan: "Generate DAN", farmer_registry: "Farmer Registry", search_placeholder: "Search Name/DAN...", th_name: "Name", th_plot: "Plot", th_area: "Area", th_status: "Status", th_action: "Action", support_inbox: "Support Inbox", btn_view: "View",
                welcome_msg: "Welcome,", farm_overview: "Here is your farm overview.", digi_id: "Digital Identity", lbl_reg_plot: "Registered Plot", lbl_tot_area: "Total Area", live_status: "Live Status", quick_actions: "Quick Actions", btn_dl_report: "Download Report", btn_apply_loan: "Apply for Loan",
                farm_condition: "Farm Condition & Yield", yield_graph: "Yield Forecast", moisture_graph: "Soil Moisture History",
                news_title: "Latest Farming News", btn_close: "Close", news_all: "All", news_loans: "Loans", news_schemes: "Schemes", news_market: "Market", news_updated: "Last update:", btn_refresh: "Refresh"
            },
            hi: {
                nav_home: "मुखपृष्ठ", nav_dashboard: "डैशबोर्ड", nav_features: "सुविधाएँ", nav_marketplace: "बाज़ार", btn_login: "लॉगिन / शुरू करें",
                hero_title_1: "खेती का भविष्य", hero_title_2: "बढ़ रहा है।", hero_subtitle: "कृषि सेतु  आपके खेतों में पारदर्शिता लाने के लिए एआई-संचालित एनालिटिक्स का उपयोग करता है।", btn_view_dash: "डैशबोर्ड देखें", btn_portal_login: "पोर्टल लॉगिन",
                dash_title: "आपका स्मार्ट फार्म डैशबोर्ड", dash_subtitle: "आपके खेतों से रीयल-टाइम डेटा। एआई-संचालित अंतर्दृष्टि।", chart_title: "फसल उपज पूर्वानुमान", sensors_title: "लाइव सेंसर", sensor_soil: "मिट्टी की नमी", sensor_sun: "सूरज की रोशनी (UV)", sensor_temp: "तापमान",
                feat_ai_title: "एआई एनालिटिक्स", feat_ai_desc: "99.8% सटीकता के साथ उपज की भविष्यवाणी और बीमारियों का पता लगाएं।", feat_auto_title: "स्मार्ट ऑटो", feat_auto_desc: "IoT ड्रोन और स्मार्ट सिंचाई प्रणालियों के साथ एकीकृत करें।", feat_block_title: "ब्लॉकचेन", feat_block_desc: "बीज से सुपरमार्केट तक ट्रेस करने योग्य आपूर्ति श्रृंखला।",
                about_title_1: "जोड़ रहे हैं", about_title_2: "किसानों को", about_desc: "हर किसान को कल की तकनीक से सशक्त बनाना।",
                market_title: "एक निष्पक्ष बाज़ार", market_desc: "हमारे सत्यापित बाज़ार पर ब्राउज़ करें, खरीदें और बेचें।", prod_saffron: "केसर", prod_drones: "ड्रोन", prod_greens: "साग-सब्ज़ी", prod_credits: "क्रेडिट",
                footer_rights: "सर्वाधिकार सुरक्षित।",
                login_title: "अपना पोर्टल चुनें", admin_login: "एडमिन लॉगिन", admin_desc: "DAN बनाएं और किसानों को पंजीकृत करें", farmer_login: "किसान लॉगिन", farmer_desc: "DAN के साथ फार्म विवरण तक पहुंचें", back_home: "वापस जाएं",
                admin_sec: "एडमिन सुरक्षा", password: "पासवर्ड", ph_pass: "दर्ज करें: admin123", btn_unlock: "पोर्टल खोलें", btn_cancel: "रद्द करें",
                farmer_access: "किसान पहुंच", enter_dan: "अपना डिजिटल आवेदन नंबर दर्ज करें", btn_view_farm: "फार्म देखें",
                admin_console: "एडमिन कंसोल", admin_console_desc: "नए किसानों को पंजीकृत करें और सहायता प्रबंधित करें", btn_logout: "लॉगआउट", add_farmer: "नया किसान जोड़ें", lbl_fullname: "पूरा नाम", lbl_plot: "प्लॉट/सर्वे नंबर", lbl_addr: "पता", lbl_area: "कुल क्षेत्रफल (एकड़)", lbl_mac: "ESP32 मैक पता", btn_gen_dan: "DAN उत्पन्न करें", farmer_registry: "किसान रजिस्ट्री", search_placeholder: "नाम/DAN खोजें...", th_name: "नाम", th_plot: "प्लॉट", th_area: "क्षेत्र", th_status: "स्थिति", th_action: "कार्रवाई", support_inbox: "सहायता इनबॉक्स", btn_view: "देखें",
                welcome_msg: "स्वागत है,", farm_overview: "यहाँ आपका खेत अवलोकन है।", digi_id: "डिजिटल पहचान", lbl_reg_plot: "पंजीकृत प्लॉट", lbl_tot_area: "कुल क्षेत्रफल", live_status: "लाइव स्थिति", quick_actions: "त्वरित कार्य", btn_dl_report: "रिपोर्ट डाउनलोड करें", btn_apply_loan: "ऋण के लिए आवेदन करें",
                farm_condition: "खेत की स्थिति और उपज", yield_graph: "उपज पूर्वानुमान", moisture_graph: "नमी का इतिहास",
                news_title: "नवीनतम कृषि समाचार", btn_close: "बंद करें", news_all: "सभी", news_loans: "ऋण", news_schemes: "योजनाएं", news_market: "बाज़ार", news_updated: "अंतिम अपडेट:", btn_refresh: "रिफ्रेश"
            },
            kn: {
                nav_home: "ಮುಖಪುಟ", nav_dashboard: "ಡ್ಯಾಶ್‌ಬೋರ್ಡ್", nav_features: "ವೈಶಿಷ್ಟ್ಯಗಳು", nav_marketplace: "ಮಾರುಕಟ್ಟೆ", btn_login: "ಲಾಗಿನ್ / ಪ್ರಾರಂಭಿಸಿ",
                hero_title_1: "ಕೃಷಿಯ ಭವಿಷ್ಯ", hero_title_2: "ಬೆಳೆಯುತ್ತಿದೆ.", hero_subtitle: "ಕೃಷಿಸೇತು  ನಿಮ್ಮ ಜಮೀನಿಗೆ ಪಾರದರ್ಶಕತೆ ತರಲು AI-ಚಾಲಿತ ವಿಶ್ಲೇಷಣೆಯನ್ನು ಬಳಸುತ್ತದೆ.", btn_view_dash: "ಡ್ಯಾಶ್‌ಬೋರ್ಡ್ ವೀಕ್ಷಿಸಿ", btn_portal_login: "ಪೋರ್ಟಲ್ ಲಾಗಿನ್",
                dash_title: "ನಿಮ್ಮ ಸ್ಮಾರ್ಟ್ ಫಾರ್ಮ್ ಡ್ಯಾಶ್‌ಬೋರ್ಡ್", dash_subtitle: "ನಿಮ்க்கು ಜಮೀನಿಂದ ನೈಜ-ಸಮಯದ ಡೇಟಾ.", chart_title: "ಬೆಳೆ ಇಳುವರಿ ಮುನ್ಸೂಚನೆ", sensors_title: "ಲೈವ್ ಸೆನ್ಸಾರ್‌ಗಳು", sensor_soil: "ಮಣ್ಣಿನ ತೇವಾಂಶ", sensor_sun: "ಸೂರ್ಯನ ಬೆಳಕು", sensor_temp: "ತಾಪಮಾನ",
                feat_ai_title: "AI ವಿಶ್ಲೇಷಣೆ", feat_ai_desc: "99.8% ನಿಖರತೆಯೊಂದಿಗೆ ಇಳುವರಿಯನ್ನು ಊಹಿಸಿ ಮತ್ತು ರೋಗಗಳನ್ನು ಪತ್ತೆ ಮಾಡಿ.", feat_auto_title: "ಸ್ಮಾರ್ಟ್ ಆಟೋ", feat_auto_desc: "ಡ್ರೋನ್ಗಳು ಮತ್ತು ಸ್ಮಾರ್ಟ್ ನೀರಾವರಿ ವ್ಯವಸ್ಥೆಗಳೊಂದಿಗೆ ಸಂಯೋಜಿಸಿ.", feat_block_title: "ಬ್ಲಾಕ್‌ಚೈನ್", feat_block_desc: "ಬೀಜದಿಂದ ಸೂಪರ್ಮಾರ್ಕೆಟ್ವರೆಗೆ ಪತ್ತೆಹಚ್ಚಬಹುದಾದ ಪೂರೈಕೆ ಸರಪಳಿ.",
                about_title_1: "ಸಂಪರ್ಕಿಸುತ್ತಿದೆ", about_title_2: "ರೈತರನ್ನು", about_desc: "ನಾಳೆಯ ತಂತ್ರಜ್ಞಾನದೊಂದಿಗೆ ಪ್ರತಿ ರೈತನನ್ನು ಸಬಲೀಕರಣಗೊಳಿಸುವುದು.",
                market_title: "ನ್ಯಾಯಯುತ ಮಾರುಕಟ್ಟೆ", market_desc: "ನಮ್ಮ ಪರಿಶೀಲಿಸಿದ ಮಾರುಕಟ್ಟೆಯಲ್ಲಿ ಬ್ರೌಸ್ ಮಾಡಿ, ಖರೀದಿಸಿ ಮತ್ತು ಮಾರಾಟ ಮಾಡಿ.", prod_saffron: "ಕೇಸರಿ", prod_drones: "ಡ್ರೋನ್ಸ್", prod_greens: "ಹಸಿರು ಸೊಪ್ಪು", prod_credits: "ಕ್ರೆಡಿಟ್ಸ್",
                footer_rights: "ಎಲ್ಲಾ ಹಕ್ಕುಗಳನ್ನು ಕಾಯ್ದಿರಿಸಲಾಗಿದೆ.",
                login_title: "ನಿಮ್ಮ ಪೋರ್ಟಲ್ ಆಯ್ಕೆಮಾಡಿ", admin_login: "ನಿರ್ವಾಹಕ ಲಾಗಿನ್", admin_desc: "DAN ರಚಿಸಿ ಮತ್ತು ರೈತರನ್ನು ನೋಂದಾಯಿಸಿ", farmer_login: "ರೈತ ಲಾಗಿನ್", farmer_desc: "DAN ನೊಂದಿಗೆ ಫಾರ್ಮ್ ವಿವರಗಳನ್ನು ಪ್ರವೇಶಿಸಿ", back_home: "ಹಿಂದಕ್ಕೆ",
                admin_sec: "ನಿರ್ವಾಹಕ ಭದ್ರತೆ", password: "ಪಾಸ್‌ವರ್ಡ್", ph_pass: "ನಮೂದಿಸಿ: admin123", btn_unlock: "ಪೋರ್ಟಲ್ ತೆರೆಯಿರಿ", btn_cancel: "ರದ್ದುಮಾಡಿ",
                farmer_access: "ರೈತ ಪ್ರವೇಶ", enter_dan: "ನಿಮ್ಮ ಡಿಜಿಟಲ್ ಅಪ್ಲಿಕೇಶನ್ ಸಂಖ್ಯೆಯನ್ನು ನಮೂದಿಸಿ", btn_view_farm: "ಫಾರ್ಮ್ ವೀಕ್ಷಿಸಿ",
                admin_console: "ನಿರ್ವಾಹಕ ಕನ್ಸೋಲ್", admin_console_desc: "ಹೊಸ ರೈತರನ್ನು ನೋಂದಾಯಿಸಿ ಮತ್ತು ಬೆಂಬಲವನ್ನು ನಿರ್ವಹಿಸಿ", btn_logout: "ಲಾಗ್ ಔಟ್", add_farmer: "ಹೊಸ ರೈತನನ್ನು ಸೇರಿಸಿ", lbl_fullname: "ಪೂರ್ಣ ಹೆಸರು", lbl_plot: "ಪ್ಲಾಟ್/ಸರ್ವೆ ನಂ.", lbl_addr: "ವಿಳಾಸ", lbl_area: "ಒಟ್ಟು ವಿಸ್ತೀರ್ಣ (ಎಕರೆ)", lbl_mac: "ESP32 MAC ವಿಳಾಸ", btn_gen_dan: "DAN ರಚಿಸಿ", farmer_registry: "ರೈತ ನೋಂದಣಿ", search_placeholder: "ಹೆಸರು/DAN ಹುಡುಕಿ...", th_name: "ಹೆಸರು", th_plot: "ಪ್ಲಾಟ್", th_area: "ವಿಸ್ತೀರ್ಣ", th_status: "ಸ್ಥಿತಿ", th_action: "ಕ್ರಮ", support_inbox: "ಬೆಂಬಲ ಇನ್‌ಬಾಕ್ಸ್", btn_view: "ವೀಕ್ಷಿಸಿ",
                welcome_msg: "ಸ್ವಾಗತ,", farm_overview: "ಇಲ್ಲಿ ನಿಮ್ಮ ಫಾರ್ಮ್ ಅವಲೋಕನವಿದೆ.", digi_id: "ಡಿಜಿಟಲ್ ಗುರುತು", lbl_reg_plot: "ನೋಂದಾಯಿತ ಪ್ಲಾಟ್", lbl_tot_area: "ಒಟ್ಟು ವಿಸ್ತೀರ್ಣ", live_status: "ಲೈವ್ ಸ್ಥಿತಿ", quick_actions: "ತ್ವರಿತ ಕ್ರಮಗಳು", btn_dl_report: "ವರದಿ ಡೌನ್‌ಲೋಡ್ ಮಾಡಿ", btn_apply_loan: "ಸಾಲಕ್ಕೆ ಅರ್ಜಿ ಸಲ್ಲಿಸಿ",
                farm_condition: "ಫಾರ್ಮ್ ಸ್ಥಿತಿ & ಇಳುವರಿ", yield_graph: "ಇಳುವರಿ ಮುನ್ಸೂಚನೆ", moisture_graph: "ತೇವಾಂಶ ಇತಿಹಾಸ",
                news_title: "ಇತ್ತೀಚಿನ ಕೃಷಿ ಸುದ್ದಿ", btn_close: "ಮುಚ್ಚಿ", news_all: "ಎಲ್ಲಾ", news_loans: "ಸಾಲಗಳು", news_schemes: "ಯೋಜನೆಗಳು", news_market: "ಮಾರುಕಟ್ಟೆ", news_updated: "ಕೊನೆಯ ನವೀಕರಣ:", btn_refresh: "ರಿಫ್ರೆಶ್"
            }
        };

        // --- STATE ---
        let farmersList = [
            {
                dan: "1234 5678 9012", name: "Demo User", plot: "Sector-7", area: "5.5", status: "Active", mac: "A1:B2:C3:D4:E5",
                yieldData: [12, 15, 14, 18, 20, 22], moistureData: [45, 42, 40, 38, 44, 46]
            }
        ];
        const CHAT_STORAGE_KEY = 'krishisetu_chat_messages';
        const SELL_OFFERS_KEY = 'krishisetu_sell_offers';
        const BUY_PRODUCTS_KEY = 'krishisetu_buy_products'; // Key for buyable products

        let globalChatMessages = [
            { sender: "KrishiSetu Bot", text: "Namaste! How can I help you?", time: new Date().toLocaleTimeString(), type: "bot", dan: null }
        ];
        let sellOffers = []; // { id, dan, name, crop, image, cost, qty, desc, status, time, seenByFarmer }
        let buyableProducts = []; // { id, name, image, price, unit, stock }

        let currentLang = localStorage.getItem('krishi_lang') || 'en';
        let charts = {}; // Store chart instances for destroy/update

        const views = {
            landing: document.getElementById('view-landing'),
            login: document.getElementById('view-login-select'),
            adminAuth: document.getElementById('view-admin-auth'),
            farmerAuth: document.getElementById('view-farmer-auth'),
            adminPanel: document.getElementById('view-admin-panel'),
            farmerDash: document.getElementById('view-farmer-dashboard')
        };
        const chatWidget = document.getElementById('chat-widget-container');
        const newsArrowContainer = document.getElementById('newsArrowContainer');
        const loginBtn = document.getElementById('login-get-started-btn');

        // DATA
        const sampleNews = [
            { id: 1, category: 'schemes', title: 'Govt launches new soil health subsidy scheme', source: 'Agri Ministry', date: '2025-11-10', excerpt: 'A new subsidy for soil health cards and micro-nutrients has been announced.' },
            { id: 2, category: 'market', title: 'Tomato prices spike in the north', source: 'MarketWatch', date: '2025-11-12', excerpt: 'Supply disruptions and lower yields have pushed tomato wholesale prices up by 28% this week.' },
            { id: 3, category: 'loans', title: 'Low-interest crop loans available through NPCI-linked banks', source: 'State Bank', date: '2025-11-09', excerpt: 'Farmers can now get priority crop loans at 6% interest with quick KYC through digital channels.' }
        ];

        // --- LANGUAGE LOGIC ---
        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('krishi_lang', lang);
            document.getElementById('language-selector').value = lang;

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });
        }

        // --- NAVIGATION & VIEWS ---
        function hideAll() {
            Object.values(views).forEach(el => { if(el) { el.classList.add('hidden-section'); el.classList.remove('fade-in'); }});
            document.getElementById('sell-product-btn').classList.add('hidden');
            document.getElementById('sell-product-btn-2').classList.add('hidden');
            newsArrowContainer.classList.add('hidden-section');
            loginBtn.classList.remove('hidden');
            window.scrollTo(0,0);
        }
        function returnHome() { hideAll(); views.landing.classList.remove('hidden-section'); views.landing.classList.add('fade-in'); chatWidget.classList.remove('hidden'); }
        function showLoginSelection() { hideAll(); views.login.classList.remove('hidden-section'); views.login.classList.add('flex'); views.login.classList.add('fade-in'); chatWidget.classList.add('hidden'); }
        function showAdminAuth() { hideAll(); views.adminAuth.classList.remove('hidden-section'); views.adminAuth.classList.add('fade-in'); document.getElementById('auth-error').classList.add('hidden'); }
        function showFarmerAuth() { hideAll(); views.farmerAuth.classList.remove('hidden-section'); views.farmerAuth.classList.add('fade-in'); document.getElementById('farmer-auth-error').classList.add('hidden'); }

        // --- AUTHENTICATION & LOGOUT ---
        function verifyAdminPassword() {
            if(document.getElementById('admin-password-input').value === 'admin123') {
                hideAll();
                views.adminPanel.classList.remove('hidden-section');
                views.adminPanel.classList.add('fade-in');
                chatWidget.classList.add('hidden');
                loginBtn.classList.add('hidden');
                renderAdminTable(); renderAdminInbox(); renderAdminSellOffers(); renderAdminProductsList();
            } else document.getElementById('auth-error').classList.remove('hidden');
        }

        function verifyFarmerLogin() {
            const input = document.getElementById('farmer-dan-input').value.replace(/\s/g, '');
            const farmer = farmersList.find(f => f.dan.replace(/\s/g, '') === input);
            if(farmer) {
                document.getElementById('dash-farmer-name').textContent = farmer.name;
                document.getElementById('dash-dan').textContent = farmer.dan;
                document.getElementById('dash-plot').textContent = farmer.plot;
                document.getElementById('dash-area').textContent = farmer.area + ' Acres';

                hideAll();
                views.farmerDash.classList.remove('hidden-section');
                views.farmerDash.classList.add('fade-in');
                newsArrowContainer.classList.remove('hidden-section');
                chatWidget.classList.remove('hidden');
                chatWidget.dataset.currentDan = farmer.dan.replace(/\s/g,'');
                loginBtn.classList.add('hidden');

                document.getElementById('sell-product-btn').classList.remove('hidden');
                document.getElementById('sell-product-btn-2').classList.remove('hidden');

                renderCharts(farmer.yieldData, farmer.moistureData, 'dashYieldChart', 'dashMoistureChart');
                loadChatFromStorage(); refreshChatWindowMessages();
                loadOffersFromStorage(); refreshFarmerOffersUI();
                loadBuyableProductsFromStorage(); renderFarmerBuyableProducts();
                updateSellBadges();
            } else document.getElementById('farmer-auth-error').classList.remove('hidden');
        }

        function logoutFromFarmer() {
            chatWidget.dataset.currentDan = '';
            hideAll();
            returnHome();
        }

        // --- ADMIN: FARMER MANAGEMENT ---
        function handleFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('input-name').value;
            const dan = Math.floor(100000000000 + Math.random() * 900000000000).toString().replace(/(.{4})/g, '$1 ').trim();
            const mac = document.getElementById('input-mac').value;
            const randYield = Array.from({length:6}, () => Math.floor(Math.random() * 25));
            const randMoist = Array.from({length:6}, () => Math.floor(Math.random() * 60));

            farmersList.push({ dan, name, plot: document.getElementById('input-plot').value, area: document.getElementById('input-area').value, status: 'Active', mac: mac, yieldData: randYield, moistureData: randMoist });
            renderAdminTable();
            document.getElementById('card-name').textContent = name; document.getElementById('card-dan').textContent = dan;
            document.getElementById('dan-modal').classList.remove('hidden');
            e.target.reset();
        }
        function closeDanModal() { document.getElementById('dan-modal').classList.add('hidden'); }

        function renderAdminTable(filterText = '') {
            const tbody = document.getElementById('farmer-table-body'); tbody.innerHTML = '';
            const filtered = farmersList.filter(f => f.name.toLowerCase().includes(filterText.toLowerCase()) || f.dan.replace(/\s/g,'').includes(filterText));

            filtered.slice().reverse().forEach(f => {
                const viewBtnText = translations[currentLang].btn_view || 'View';
                tbody.innerHTML += `<tr>
                    <td class="font-mono text-green-400">${f.dan}</td>
                    <td class="text-white">${f.name}</td>
                    <td class="text-gray-400">${f.plot}</td>
                    <td class="text-gray-400">${f.area}</td>
                    <td>
                        <button onclick="viewFarmerDetails('${f.dan}')" class="text-sm bg-blue-900/50 text-blue-300 border border-blue-800 px-3 py-1 rounded hover:bg-blue-800 mr-2">${viewBtnText}</button>
                        <button onclick="deleteFarmer('${f.dan}')" class="text-sm text-red-400 border border-red-900 px-3 py-1 rounded hover:bg-red-900/20">Del</button>
                    </td>
                </tr>`;
            });
        }

        function searchFarmer() { renderAdminTable(document.getElementById('admin-search-input').value); }
        function deleteFarmer(dan) { if(!confirm('Delete farmer with DAN ' + dan + '?')) return; const idx = farmersList.findIndex(f => f.dan === dan); if(idx >= 0) { farmersList.splice(idx, 1); renderAdminTable(document.getElementById('admin-search-input').value); } }

        function viewFarmerDetails(dan) {
            const f = farmersList.find(x => x.dan === dan); if(!f) return;
            document.getElementById('view-name').textContent = f.name; document.getElementById('view-dan').textContent = f.dan; document.getElementById('view-mac').textContent = f.mac || 'N/A';
            document.getElementById('admin-farmer-view-modal').classList.remove('hidden');
            setTimeout(() => renderCharts(f.yieldData, f.moistureData, 'adminViewYieldChart', 'adminViewMoistureChart'), 200);
        }
        function closeAdminViewModal() { document.getElementById('admin-farmer-view-modal').classList.add('hidden'); }

        // --- ADMIN: MANAGE BUYABLE SUPPLIES ---
        function saveBuyableProductsToStorage() { try { localStorage.setItem(BUY_PRODUCTS_KEY, JSON.stringify(buyableProducts)); } catch(e){ console.warn(e); } }
        function loadBuyableProductsFromStorage() { try { const raw = localStorage.getItem(BUY_PRODUCTS_KEY); if(raw){ const p = JSON.parse(raw); if(Array.isArray(p)) buyableProducts = p; } } catch(e){ console.warn(e); } }

        function handleProductFormSubmit(e) {
            e.preventDefault();
            const product = {
                id: 'prod_' + Date.now(),
                name: document.getElementById('input-prod-name').value,
                image: document.getElementById('input-prod-image').value,
                price: parseFloat(document.getElementById('input-prod-price').value),
                unit: document.getElementById('input-prod-unit').value,
                stock: parseInt(document.getElementById('input-prod-stock').value)
            };
            buyableProducts.push(product);
            saveBuyableProductsToStorage();
            renderAdminProductsList();
            renderFarmerBuyableProducts(); // Also update farmer view if open
            e.target.reset();
        }

        function renderAdminProductsList() {
            const container = document.getElementById('admin-products-list');
            if(buyableProducts.length === 0) { container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No supplies added yet.</div>'; return; }
            container.innerHTML = '';
            buyableProducts.slice().reverse().forEach(p => {
                container.innerHTML += `
                    <div class="bg-white/5 p-3 rounded-lg border border-white/10 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <img src="${escapeHtml(p.image)}" alt="${escapeHtml(p.name)}" class="w-16 h-16 object-cover rounded-lg">
                            <div>
                                <p class="text-white font-semibold">${escapeHtml(p.name)}</p>
                                <p class="text-sm text-green-400">₹${escapeHtml(p.price)} / ${escapeHtml(p.unit)}</p>
                                <p class="text-xs text-gray-400">Stock: ${escapeHtml(p.stock)}</p>
                            </div>
                        </div>
                        <button onclick="deleteAdminProduct('${p.id}')" class="text-sm text-red-400 border border-red-900 px-3 py-1 rounded hover:bg-red-900/20">Delete</button>
                    </div>`;
            });
        }

        function deleteAdminProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            buyableProducts = buyableProducts.filter(p => p.id !== productId);
            saveBuyableProductsToStorage();
            renderAdminProductsList();
            renderFarmerBuyableProducts();
        }


        // --- FARMER: BUY SUPPLIES ---
        function renderFarmerBuyableProducts() {
            const container = document.getElementById('farmer-buy-products-list');
            if(!container) return;
            if(buyableProducts.length === 0) { container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No supplies available right now.</div>'; return; }
            container.innerHTML = '';
            buyableProducts.forEach(p => {
                const stockInfo = p.stock > 0 ? `${p.stock} ${p.unit}s available` : 'Out of Stock';
                const buttonDisabled = p.stock > 0 ? '' : 'disabled style="background-color: #555; cursor: not-allowed;"';
                container.innerHTML += `
                    <div class="supply-card">
                        <img src="${escapeHtml(p.image)}" alt="${escapeHtml(p.name)}">
                        <div class="flex-1">
                            <h4 class="text-lg font-bold text-white">${escapeHtml(p.name)}</h4>
                            <p class="text-green-400 font-semibold">₹${escapeHtml(p.price)} / ${escapeHtml(p.unit)}</p>
                            <span class="stock">${stockInfo}</span>
                        </div>
                        <button onclick="buyProduct('${p.id}')" class="neon-button w-full mt-4 py-2 text-sm" ${buttonDisabled}>Buy Now</button>
                    </div>`;
            });
        }

        function buyProduct(productId) {
            const productIndex = buyableProducts.findIndex(p => p.id === productId);
            if (productIndex === -1) return;
            const product = buyableProducts[productIndex];

            if (product.stock <= 0) { alert('This product is out of stock.'); return; }

            const qty = prompt(`How many ${product.unit}s of ${product.name} would you like to buy? (Available: ${product.stock})`, "1");
            if (qty === null || isNaN(qty) || parseInt(qty) <= 0) return;

            const quantityToBuy = parseInt(qty);
            if (quantityToBuy > product.stock) {
                alert(`Cannot buy ${quantityToBuy} units. Only ${product.stock} available.`);
                return;
            }

            if (confirm(`Confirm purchase of ${quantityToBuy} ${product.unit}(s) of ${product.name} for ₹${quantityToBuy * product.price}?`)) {
                buyableProducts[productIndex].stock -= quantityToBuy;
                saveBuyableProductsToStorage();
                renderFarmerBuyableProducts();
                renderAdminProductsList(); // Update admin view as well
                alert('Purchase successful!');
            }
        }


        // --- CHARTS LOGIC ---
        function renderCharts(yieldData, moistureData, yieldCanvasId, moistCanvasId) {
            if(charts[yieldCanvasId]) charts[yieldCanvasId].destroy();
            if(charts[moistCanvasId]) charts[moistCanvasId].destroy();
            const ctx1El = document.getElementById(yieldCanvasId);
            if(ctx1El) charts[yieldCanvasId] = new Chart(ctx1El.getContext('2d'), { type: 'line', data: { labels: ['Jan','Feb','Mar','Apr','May','Jun'], datasets: [{ label: 'Yield Forecast', data: yieldData, borderColor: '#4ade80', backgroundColor: 'rgba(74,222,128,0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{grid:{color:'rgba(255,255,255,0.05)'}}, x:{grid:{color:'rgba(255,255,255,0.05)'}}} } });
            const ctx2El = document.getElementById(moistCanvasId);
            if(ctx2El) charts[moistCanvasId] = new Chart(ctx2El.getContext('2d'), { type: 'bar', data: { labels: ['Jan','Feb','Mar','Apr','May','Jun'], datasets: [{ label: 'Moisture %', data: moistureData, backgroundColor: '#60a5fa', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{grid:{color:'rgba(255,255,255,0.05)'}}, x:{grid:{color:'rgba(255,255,255,0.05)'}}} } });
        }

        // --- CHAT PERSISTENCE ---
        function saveChatToStorage() { try { localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(globalChatMessages)); } catch (err) { console.warn(err); } }
        function loadChatFromStorage() { try { const raw = localStorage.getItem(CHAT_STORAGE_KEY); if(raw) { const p = JSON.parse(raw); if(Array.isArray(p)) globalChatMessages = p; } } catch (err) { console.warn(err); } }

        window.addEventListener('storage', (ev) => { if (ev.key === CHAT_STORAGE_KEY) { loadChatFromStorage(); renderAdminInbox(); refreshChatWindowMessages(); } if(ev.key === SELL_OFFERS_KEY) { loadOffersFromStorage(); renderAdminSellOffers(); refreshFarmerOffersUI(); updateSellBadges(); } if(ev.key === BUY_PRODUCTS_KEY) { loadBuyableProductsFromStorage(); renderAdminProductsList(); renderFarmerBuyableProducts(); } });

        // --- CHAT UI ---
        function toggleChat() { document.getElementById('chat-window').classList.toggle('hidden'); if (!document.getElementById('chat-window').classList.contains('hidden')) setTimeout(() => document.getElementById('user-chat-input').focus(), 200); }

        function sendUserMessage(e) {
            e.preventDefault();
            const input = document.getElementById('user-chat-input'); const msg = input.value.trim(); if(!msg) return;
            const list = document.getElementById('chat-messages');
            const bubble = document.createElement('div'); bubble.className = 'chat-bubble-user'; bubble.textContent = msg;
            list.appendChild(bubble); list.scrollTop = list.scrollHeight; input.value = '';
            const currentDan = (chatWidget.dataset.currentDan && chatWidget.dataset.currentDan.length>0) ? chatWidget.dataset.currentDan : null;
            const sender = currentDan ? ("Farmer (" + document.getElementById('dash-farmer-name').textContent + ")") : "Visitor";
            globalChatMessages.push({ sender, text: msg, time: new Date().toLocaleTimeString(), type: "user", dan: currentDan });
            saveChatToStorage(); renderAdminInbox();
            setTimeout(() => {
                const botText = "Message received. Admin will contact you.";
                const bot = document.createElement('div'); bot.className = 'chat-bubble-bot'; bot.textContent = botText;
                list.appendChild(bot); list.scrollTop = list.scrollHeight;
                globalChatMessages.push({ sender: "KrishiSetu Bot", text: botText, time: new Date().toLocaleTimeString(), type: "bot", dan: currentDan });
                saveChatToStorage(); renderAdminInbox();
            }, 700);
        }

        function renderAdminInbox() {
            const list = document.getElementById('admin-chat-list'); if(!list) return;
            const userMessages = globalChatMessages.filter(m => m.type === 'user');
            if(userMessages.length === 0) { list.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No new messages.</div>'; return; }
            list.innerHTML = '';
            userMessages.slice().reverse().forEach((m) => {
                const displayDan = m.dan ? formatDanDisplay(m.dan) : 'Visitor';
                list.innerHTML += `<div class="bg-white/5 p-3 rounded-lg border border-white/10 flex justify-between items-start mb-2"> <div style="flex:1"> <div class="flex items-center gap-2 mb-1"><span class="text-green-400 text-sm font-bold">${escapeHtml(displayDan)}</span><span class="text-gray-500 text-xs ml-2">${m.time}</span></div> <p class="text-gray-300 text-sm">${escapeHtml(m.text)}</p> </div> </div>`;
            });
        }

        function refreshChatWindowMessages() {
            const list = document.getElementById('chat-messages'); if (!list) return; list.innerHTML = '';
            const currentDan = (chatWidget.dataset.currentDan || '').replace(/\s/g,'');
            const visible = globalChatMessages.filter(m => { const mDan = m.dan ? (m.dan+'').replace(/\s/g,'') : null; return currentDan ? (mDan === currentDan) : (mDan === null); });
            if(visible.length === 0) { const el = document.createElement('div'); el.className = 'chat-bubble-bot'; el.textContent = 'Namaste! How can I help you?'; list.appendChild(el); return; }
            visible.forEach(m => { const el = document.createElement('div'); el.className = (m.type === 'user') ? 'chat-bubble-user' : 'chat-bubble-bot'; el.textContent = m.text; list.appendChild(el); });
            list.scrollTop = list.scrollHeight;
        }

        // --- NEWS PANEL LOGIC ---
        const newsPanel = document.getElementById('newsPanel');
        const newsListEl = document.getElementById('newsList');
        const newsFilters = Array.from(document.querySelectorAll('.news-filter'));
        const newsLastUpdatedEl = document.getElementById('news-last-updated');
        let currentFilter = 'all';

        function toggleNews() { newsPanel.classList.toggle('open'); if(newsPanel.classList.contains('open')) renderNews(currentFilter); }
        document.getElementById('closeNewsBtn').addEventListener('click', () => newsPanel.classList.remove('open'));
        document.getElementById('refreshNewsBtn').addEventListener('click', () => renderNews(currentFilter));
        newsFilters.forEach(btn => { btn.addEventListener('click', () => { newsFilters.forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentFilter = btn.dataset.filter; renderNews(currentFilter); }); });

        function renderNews(filter = 'all') {
            const items = sampleNews.filter(n => (filter === 'all') ? true : n.category === filter);
            newsListEl.innerHTML = (items.length === 0) ? `<div class="news-empty">No news found.</div>` : items.map(it => `<div class="news-card"><div class="meta"><div>${escapeHtml(it.source)}</div><div>${escapeHtml(it.date)}</div></div><div class="title">${escapeHtml(it.title)}</div><div class="excerpt">${escapeHtml(it.excerpt)}</div></div>`).join('');
            newsLastUpdatedEl.textContent = new Date().toLocaleTimeString();
        }

        // --- HELPERS ---
        function escapeHtml(unsafe) { return String(unsafe || '').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function formatDanDisplay(dan){ if(!dan) return 'Visitor'; return (dan.length===12 || dan.includes(' ')) ? dan : (dan.replace(/(.{4})/g,'$1 ').trim()); }

        // --- SELL OFFERS ---
        function saveOffersToStorage() { try { localStorage.setItem(SELL_OFFERS_KEY, JSON.stringify(sellOffers)); } catch(e){ console.warn(e); } }
        function loadOffersFromStorage() { try { const raw = localStorage.getItem(SELL_OFFERS_KEY); if(raw){ const p = JSON.parse(raw); if(Array.isArray(p)) sellOffers = p; } } catch(e){ console.warn(e); } }

        document.addEventListener('input', (ev) => {
            if(!document.getElementById('sell-modal') || document.getElementById('sell-modal').classList.contains('hidden')) return;
            const crop = document.getElementById('sell-crop').value, img = document.getElementById('sell-image').value, cost = document.getElementById('sell-cost').value, qty = document.getElementById('sell-qty').value;
            const preview = document.getElementById('sell-preview');
            if(crop || img || cost || qty) {
                preview.classList.remove('hidden');
                preview.innerHTML = `<img src="${escapeHtml(img || 'https://via.placeholder.com/64')}" alt="${escapeHtml(crop)}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;"><div style="margin-left:8px"><div class="font-semibold">${escapeHtml(crop || 'Product')}</div><div class="text-xs text-gray-300">${escapeHtml(qty || '')} kg • ₹${escapeHtml(cost || '')}</div></div>`;
            } else preview.classList.add('hidden');
        });

        function openSellModal(){ const dan = (chatWidget.dataset.currentDan || '').replace(/\s/g,''); if(!dan){ alert('Please login to sell produce.'); return; } document.getElementById('sellForm').reset(); document.getElementById('sell-preview').classList.add('hidden'); document.getElementById('sell-modal').classList.remove('hidden'); }
        function closeSellModal(){ document.getElementById('sell-modal').classList.add('hidden'); }

        function submitSellOffer(e){
            e.preventDefault();
            const dan = (chatWidget.dataset.currentDan || '').replace(/\s/g,''); if(!dan){ alert('Login required.'); return; }
            const offer = { id: 'offer_' + Date.now(), dan, name: document.getElementById('dash-farmer-name').textContent, crop: document.getElementById('sell-crop').value, image: document.getElementById('sell-image').value, cost: document.getElementById('sell-cost').value, qty: document.getElementById('sell-qty').value, desc: document.getElementById('sell-desc').value, status: 'pending', time: new Date().toLocaleTimeString(), seenByFarmer: true };
            sellOffers.push(offer); saveOffersToStorage();
            globalChatMessages.push({ sender: `SellOffer:${offer.name}`, text: `${offer.name} submitted an offer: ${offer.crop}`, time: offer.time, type: "user", dan });
            saveChatToStorage();
            closeSellModal(); alert('Offer submitted for review.');
            renderAdminSellOffers(); renderAdminInbox(); refreshFarmerOffersUI(); updateSellBadges();
        }

        function renderAdminSellOffers(){
            const container = document.getElementById('admin-offers-list'), filter = document.getElementById('admin-offer-filter').value;
            let items = (filter === 'all') ? sellOffers : sellOffers.filter(o => o.status === filter);
            if(items.length === 0){ container.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No offers found.</div>'; return; }
            container.innerHTML = '';
            items.slice().reverse().forEach(o => {
                container.innerHTML += `<div class="bg-white/5 p-3 rounded-lg border border-white/10 flex justify-between items-start mb-2"> <div style="flex:1"> <div class="flex items-center gap-2 mb-1"><span class="text-green-400 text-sm font-bold">${escapeHtml(formatDanDisplay(o.dan))}</span><span class="text-gray-500 text-xs ml-2">${escapeHtml(o.time)}</span></div> <div class="flex gap-3 items-center"> <img src="${escapeHtml(o.image || 'https://via.placeholder.com/56')}" alt="${escapeHtml(o.crop)}" style="width:56px;height:56px;object-fit:cover;border-radius:8px;"> <div> <div class="text-white font-semibold">${escapeHtml(o.crop)}</div> <div class="text-gray-300 text-sm">${escapeHtml(o.qty)} kg • ₹${escapeHtml(o.cost)}</div> <div class="offer-timeline mt-2"> <div class="timeline-step">${o.status === 'pending' ? '<span class="text-yellow-300">Pending</span>' : escapeHtml(o.status.charAt(0).toUpperCase()+o.status.slice(1))}</div> </div> </div> </div> </div> <div class="ml-3 flex flex-col gap-2"> ${ o.status === 'pending' ? `<button onclick="acceptSellOffer('${o.id}')" class="text-sm bg-green-500 text-black px-3 py-1 rounded hover:bg-green-400">Accept</button><button onclick="declineSellOffer('${o.id}')" class="text-sm bg-red-700 text-white px-3 py-1 rounded hover:bg-red-600">Decline</button>` : `<div class="text-xs text-gray-400 px-3 py-1 rounded">${escapeHtml(o.status)}</div>` } </div> </div>`;
            });
        }

        function updateOfferStatus(offerId, newStatus, message) {
            const idx = sellOffers.findIndex(o => o.id === offerId); if(idx === -1) return;
            sellOffers[idx].status = newStatus; sellOffers[idx].seenByFarmer = false;
            saveOffersToStorage();
            const o = sellOffers[idx];
            globalChatMessages.push({ sender: "KrishiSetu Admin", text: message, time: new Date().toLocaleTimeString(), type: "admin", dan: o.dan });
            saveChatToStorage();
            renderAdminSellOffers(); renderAdminInbox(); refreshFarmerOffersUI(); updateSellBadges();
            alert(`Offer ${newStatus}. Farmer notified.`);
        }

        function acceptSellOffer(offerId){ updateOfferStatus(offerId, 'accepted', `Your sell offer for ${sellOffers.find(o=>o.id===offerId).crop} has been accepted.`); }
        function declineSellOffer(offerId){ updateOfferStatus(offerId, 'declined', `Your sell offer for ${sellOffers.find(o=>o.id===offerId).crop} has been declined.`); }

        function refreshFarmerOffersUI(){
            const list = document.getElementById('farmer-offers-list'), dan = (chatWidget.dataset.currentDan || '').replace(/\s/g,'');
            if(!list || !dan) return;
            const myOffers = sellOffers.filter(o => (o.dan+'').replace(/\s/g,'') === dan);
            document.getElementById('my-offers-count').textContent = myOffers.length; document.getElementById('my-offers-count').classList.toggle('hidden', myOffers.length === 0);
            if(myOffers.length === 0){ list.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No sell offers yet.</div>'; return; }
            list.innerHTML = myOffers.slice().reverse().map(o => {
                const statusColor = o.status === 'pending' ? 'text-yellow-300' : (o.status === 'accepted' ? 'text-green-300' : 'text-red-300');
                const seenMarker = (!o.seenByFarmer && o.status !== 'pending') ? '<span class="small-badge ml-2">New</span>' : '';
                return `<div class="bg-white/5 p-3 rounded-lg border border-white/10 mb-2"> <div class="flex justify-between items-start"> <div> <div class="font-semibold text-white">${escapeHtml(o.crop)} ${seenMarker}</div> <div class="text-gray-300 text-sm">${escapeHtml(o.qty)} kg • ₹${escapeHtml(o.cost)}</div> </div> <div class="text-sm ${statusColor}">${escapeHtml(o.status.toUpperCase())}</div> </div> </div>`;
            }).join('');
            sellOffers.forEach(o => { if((o.dan+'').replace(/\s/g,'') === dan) o.seenByFarmer = true; });
            saveOffersToStorage(); updateSellBadges();
        }

        function updateSellBadges(){
            const dan = (chatWidget.dataset.currentDan || '').replace(/\s/g,'');
            const count = dan ? sellOffers.filter(o=> (o.dan+'').replace(/\s/g,'')===dan && !o.seenByFarmer && o.status !== 'pending').length : 0;
            [document.getElementById('sell-notif-badge'), document.getElementById('sell-notif-badge-2')].forEach(b => { if(b){ b.textContent = count; b.classList.toggle('hidden', count === 0); }});
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('preloader').classList.add('loaded');
            document.getElementById('current-year').textContent = new Date().getFullYear();

            const ctx = document.getElementById('cropHealthChart').getContext('2d');
            new Chart(ctx, { type: 'line', data: { labels: ['J','F','M','A','M','J'], datasets: [{ data: [12,15,14,18,20,22], borderColor: '#4ade80', backgroundColor: 'rgba(74,222,128,0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:true, grid:{color:'rgba(255,255,255,0.05)'}}} } });

            const observer = new IntersectionObserver((entries) => { entries.forEach(e => { if(e.isIntersecting) e.target.classList.add('is-visible'); }); });
            document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));

            loadChatFromStorage();
            loadOffersFromStorage();
            loadBuyableProductsFromStorage();
            renderAdminTable(); renderAdminInbox(); renderAdminSellOffers(); renderAdminProductsList();
            renderNews('all');
            changeLanguage(currentLang);
            updateSellBadges();
        });

        // Expose functions for inline onclick
        Object.assign(window, { returnHome, showLoginSelection, showAdminAuth, showFarmerAuth, verifyAdminPassword, verifyFarmerLogin, logoutFromFarmer, viewFarmerDetails, deleteFarmer, closeDanModal, toggleChat, sendUserMessage, openSellModal, closeSellModal, submitSellOffer, acceptSellOffer, declineSellOffer, renderAdminSellOffers, refreshFarmerOffersUI, updateSellBadges, handleFormSubmit, handleProductFormSubmit, deleteAdminProduct, buyProduct, changeLanguage, toggleNews });

